<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Calendar</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <!--link rel='stylesheet' type='text/css' media='screen' href='main.css'-->
    <style>
        #template {
            display: none;
        }

        .calendar {
            display: flex;
        }


    </style>
    <script>

        class LocalDB {
            db

            setDB(name) {
                return new Promise((resolve, reject) => {

                    const request = window.indexedDB.open("calendar", 1)

                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result
                        const store = this.db.createObjectStore("appointments", { autoIncrement: true })
                        //this.store = this.db.createObjectStore("appointments", { keyPath: dateid })
                        store.createIndex("noteIndex", "noteid", { unique: false, multiEntry: true });
                    }

                    request.onsuccess = (event) => {
                        this.db = event.target.result
                        resolve(request.result)
                    }

                    request.onerror = (e) => reject(e.target.error)
                })
            }

            insertAppointment(noteid, content) {
                return new Promise((resolve, reject) => {
                    const tnx = this.db.transaction(["appointments"], "readwrite")
                    tnx.onerror = (event) => reject(event.target.error)

                    const store = tnx.objectStore("appointments")
                    const res = store.add({noteid:noteid, content:content})
                    
                    res.onerror = (e) => reject(e.target.error)
                    res.onsuccess = () => {resolve(res.result)}
                })
            }

            loadAppointments(noteid) {
                return new Promise((resolve, reject)=>{
                    const tnx = this.db.transaction(["appointments"], "readonly")
                    tnx.onerror = (event) => reject(event.target.error)

                    const store = tnx.objectStore("appointments")
                    const index = store.index("noteIndex")
                    const results = [] // thread safe?
                    const request = index.openCursor()//IDBKeyRange.upperBound(dateid))
                    // TODO 
                    request.onsuccess = (event) => {
                        const cursor = event.target.result

                        if (cursor) {
                            results.push(cursor.value)
                            cursor.continue();
                        }

                        resolve(results)
                    }

                    request.onerror = (event) => {
                        console.error("Error retrieving data:", event.target.error);
                    }
                })
            }
        

            updateAppointment(noteid, contet) {

            }
        }

        var db = undefined

        window.addEventListener("load", () => {
            (async () => {
                db = new LocalDB()

                await db.setDB("calendar")

                console.log(db)
                dateid = "20250315"
                await db.insertAppointment("20250315#", "Heute")
                apps = await db.loadAppointments("20250315")
                console.log(apps)
            })()
        })

    </script>
</head>
<body>
    <div class="container" >
        <div class="calendar" id="cal">
        </div>
        <div class="week" id="template">
            <div class="day">
                <span class="daynr">1</span>
                <input/>
            </div>
            <br/>
            <div class="day">
                <span class="daynr">2</span>
                <input/>
            </div>
            <br/>
            <div class="day">
                <span class="daynr">3</span>
                <input/>
            </div>
            <br/>
            <div class="day">
                <span class="daynr">4</span>
                <input/>
            </div>
            <br/>
            <div class="day">
                <span class="daynr">5</span>
                <input/>
            </div>
            <br/>
            <div class="day">
                <span class="daynr">6</span>
                <input/>
            </div>
            <br/>
            <div class="day">
                <span class="daynr">7</span>
                <input/>
            </div>
        </div>
    </div>
</body>
</html>